# 系统调优

## `/etc/sysctl.conf` 

```bash
# /etc/sysctl.conf
# 防止 IP 欺骗攻击, 模式 2 在非对称路由场景下仍能工作
# 模式 1 允许非对称路由
# 严格模式的反向路径过滤. 它会检查数据包的源地址是否可以通过接收数据的接口到达(入站数据包的源地址与路由表中的路径匹配), 以防止IP欺骗.
# 但是, 在复杂路由环境中(如多路径)可能会引起问题, 所以有时会设置为0(关闭)或1(宽松模式).
# 这里设置为2, 表示严格模式, 增强安全性. 防止 DDoS 攻击
net.ipv4.conf.all.rp_filter = 2         # 严格模式反向路径验证 
net.ipv4.conf.default.rp_filter = 2     # 对新接口使用相同配置

# 禁止接受ICMP重定向消息, 防止攻击者通过重定向改变路由表
net.ipv4.conf.all.accept_redirects = 0  # 禁止ICMP重定向
net.ipv6.conf.all.accept_redirects = 0

net.ipv4.conf.all.send_redirects = 0    # 禁止发送重定向, 服务器不需要, 路由器才需要

# 禁止处理源路由数据包, 源路由可以用于攻击, 比如绕过防火墙
net.ipv4.conf.all.accept_source_route = 0   # 禁止源路由
net.ipv6.conf.all.accept_source_route = 0

fs.file-max = 1048576   # 系统最大文件描述符
fs.nr_open = 1048576    # 单进程最大文件描述符

net.ipv4.ip_local_port_range = 1025 65535

# TCP 内存配置
# 单位页(4KB)
# 低于768MB时无压力, 1024MB进入压力模式, 1536MB以上时拒绝分配
net.ipv4.tcp_mem = 196608 262144 393216	# 768M 1024M 1536M
# TCP 读写缓冲区, 单位字节, 根据网络状况自动调整
# 最小, 默认, 最大
net.ipv4.tcp_rmem = 8192 87380 67108864
net.ipv4.tcp_wmem = 8192 65536 67108864
# 启用窗口缩放, 选择性确认和时间戳, 提高TCP性能
net.ipv4.tcp_window_scaling = 1     # 支持大TCP窗口, 允许TCP窗口大于64KB, 适用于高速网络
net.ipv4.tcp_sack = 1               # 选择性确认, 提高重传效率
net.ipv4.tcp_timestamps = 1         # 时间戳, 精确RTT测量, 防止序列号回绕, 有助于安全(防止旧连接的数据包被误接收) 

# 相比默认的 cublic 算法, BBR 算法在高带宽延迟网络中有更好的带宽利用, 更低的延迟

net.ipv4.tcp_congestion_control = bbr   # 使用BBR拥塞控制算法, 适用于高带宽, 高延时网络, 能够充分利用带宽

# 连接建立
# 出现SYN洪水攻击时, 启动可以保护系统, 防止攻击导致拒绝服务
# 它通过计算一个哈希值来验证SYN-ACK, 而不需要在服务器上存储半连接状态, 从而减轻资源消耗.  
net.ipv4.tcp_syncookies = 1             # 启用SYN Cookie保护, 防御 syn flood 攻击, 当 tcp_max_syn_backlog 队列满启用
net.ipv4.tcp_max_syn_backlog = 204800   # SYN 半连接队列的最大长度, 应对高并发
net.ipv4.tcp_synack_retries = 2         # SYN-ACK重试次数, 减少SYN重试次数, 快速失败避免长时间等待
net.ipv4.tcp_syn_retries = 2            # SYN重试次数, 减少SYN重试次数, 快速失败避免长时间等待
# TCP监听队列的最大长度
net.core.somaxconn = 65535              # 已完成连接accept队列的最大长度, 高并发需要调大

# FIN 和 TIME_WAIT 处理
# 调整 TIME_WAIT 状态超时时间, 允许重用 TIME_WAIT 状态端口, 限制 TIME_WAIT 状态的连接数, 提高端口利用率
net.ipv4.tcp_fin_timeout = 30           # FIN_WAIT_2超时
net.ipv4.tcp_tw_reuse = 1               # 重用TIME_WAIT连接, 允许将TIME_WAIT套接字重新用于新的TCP连接
net.ipv4.tcp_max_tw_buckets = 100000    # TIME_WAIT连接上限, 超过直接关闭

# 异常处理
net.ipv4.tcp_orphan_retries = 1         # 孤儿连接(已关闭但未发送完数据)重试次数
net.ipv4.tcp_max_orphans = 4096         # 最大孤儿连接数, 超过立即重置

# Fast Open
net.ipv4.tcp_fastopen = 3               # 允许在SYN包中携带数据, 加速连接建立. 3表示客户端和服务端都启用TFO

# 长连接保活, 检测死链
net.ipv4.tcp_keepalive_time = 300       # 保活检测间隔: 5分钟, 默认7200s内没有收到数据包, 则认为连接已断开
net.ipv4.tcp_keepalive_intvl = 60       # 保活重试间隔: 60秒, 默认75s
net.ipv4.tcp_keepalive_probes = 3       # 保活重试次数, 默认3次, 超过则认为连接已断开

# UDP 内存配置
net.ipv4.udp_mem = 262144 393216 524288 # 1024M 1536M 2048M
net.ipv4.udp_rmem_min = 65536           # 最小接收缓冲区
net.ipv4.udp_wmem_min = 65536           # 最小发送缓冲区
# Socket 缓冲区
net.core.rmem_default = 16777216      # 默认接收缓冲区 16MB
net.core.rmem_max = 16777216          # 最大接收缓冲区
net.core.wmem_default = 16777216      # 默认发送缓冲区
net.core.wmem_max = 16777216          # 最大发送缓冲区

# 网络设备处理
# 设置网络设备接收队列的最大长度, 以及处理网络数据包的预算, 防止数据包丢失
# netdev_max_backlog: 1.5KB * 200000 ≈ 300MB
net.core.netdev_max_backlog = 200000    # 网卡后备队列, 当内核处理速度比网卡接收速度慢时, 设备队列的最大包数
net.core.netdev_budget = 5000           # NAPI处理包数量, 控制一次NAPI轮询中处理的数据包数量
net.core.netdev_budget_usecs = 10000    # NAPI处理时间, 控制一次NAPI轮询中处理的数据包数量
net.core.dev_weight = 512               # 网卡权重, 在NAPI轮询中, 从设备队列中一次最多处理的数据包数量, 增加此值可以提高处理能力

# 选项内存最大值
net.core.optmem_max = 8388608               # 每个套接字允许使用的辅助数据(如控制信息)的最大大小

# 邻居表垃圾回收阈值
# 避免在大量连接时ARP表项被过早回收
net.ipv4.neigh.default.gc_thresh1 = 2048    # ARP表项软限制
net.ipv4.neigh.default.gc_thresh2 = 8192    # ARP表项硬限制  
net.ipv4.neigh.default.gc_thresh3 = 16384   # ARP表项最大限制

# 限制ICMP消息的发送速率, 防止ICMP洪水攻击
net.ipv4.icmp_ratelimit = 500               # ICMP消息速率限制
net.ipv4.icmp_ratemask = 6160               # 限制特定类型的ICMP

# 虚拟内存管理
vm.swappiness = 1                       # 控制内核将内存页从物理内存交换到磁盘的倾向性, 值0-100, 0表示不交换, 100表示立即交换
vm.vfs_cache_pressure = 200             # 控制内核回收inode/dentry缓存, 避免过多占用内存
vm.min_free_kbytes = 65536              # 系统最小保留空闲内存: 64MB
vm.dirty_ratio = 15                     # 系统脏页比例阈值, 脏页超过此比例时, 开始阻塞进程, 强制回写到磁盘
vm.dirty_background_ratio = 5           # 后台回写阈值, 脏页超过此比例时, 启动后台回写
```